# 4K对齐下 虚拟地址转换成物理地址的过程

## 调试工具windbg 

## 环境 双机调试

虚拟机: windows 7 sp1 x64

主机：Windows10 1703 x64



![INTEL](https://github.com/ellen2015/VA2PA/blob/master/va2pa/4ks.png)



测试虚拟地址 0x00401020

``` c
kd> .formats 401020
Evaluate expression:
  Hex:     00000000`00401020
  Decimal: 4198432
  Octal:   0000000000000020010040
  Binary:  00000000 00000000 00000000 00000000 00000000 01000000 00010000 00100000
  Chars:   .....@. 
  Time:    Wed Feb 18 07:13:52 1970
  Float:   low 5.88326e-039 high 0
  Double:  2.0743e-317

低48位 9 - 9 - 9 - 9 - 12
000000000 000000000 000000010 000000001 000000100000

    0 
    0
    2
    1
    20 --- offset

PROCESS fffffa800d8ab8f0
    SessionId: 1  Cid: 0ce4    Peb: 7efdf000  ParentCid: 0648
    DirBase: 2360f000  ObjectTable: fffff8a002e882b0  HandleCount:  59.
    Image: PEiD.exe

DirBase: 2360f000  
kd> .process /r /p fffffa800d8ab8f0			//  附加进程

kd> db 401020
00000000`00401020  64 89 10 68 30 10 40 00-c3 e9 d2 ff ff ff eb f8  d..h0.@.........
00000000`00401030  5d c3 8b c0 83 2d 00 70-40 00 01 c3 c3 8d 40 00  ]....-.p@.....@.
00000000`00401040  c3 8d 40 00 55 8b ec 33-c0 55 68 69 10 40 00 64  ..@.U..3.Uhi.@.d
00000000`00401050  ff 30 64 89 20 ff 05 04-70 40 00 33 c0 5a 59 59  .0d. ...p@.3.ZYY
00000000`00401060  64 89 10 68 70 10 40 00-c3 e9 92 ff ff ff eb f8  d..hp.@.........
00000000`00401070  5d c3 8b c0 83 2d 04 70-40 00 01 c3 85 d2 74 1f  ]....-.p@.....t.
00000000`00401080  57 51 56 89 c7 31 c9 31-c0 f7 d1 f2 ae 4f 57 89  WQV..1.1.....OW.
00000000`00401090  d7 f2 ae 89 f9 29 d1 89-d6 5f f3 a4 5e 59 5f c3  .....)..._..^Y_.

// 四级页表转换
kd> !dq 2360f000 + 0*8
#2360f000 00700000`1af57867 00000000`00000000
#2360f010 00000000`00000000 00000000`00000000
#2360f020 00000000`00000000 00000000`00000000
#2360f030 00000000`00000000 00000000`00000000
#2360f040 00000000`00000000 00000000`00000000
#2360f050 00000000`00000000 00000000`00000000
#2360f060 00000000`00000000 00000000`00000000
#2360f070 00000000`00000000 00000000`00000000
kd> !dq 1af57000 + 0*8
#1af57000 06100000`167f1867 00800000`1af58867
#1af57010 00000000`00000000 00000000`00000000
#1af57020 00000000`00000000 00000000`00000000
#1af57030 00000000`00000000 00000000`00000000
#1af57040 00000000`00000000 00000000`00000000
#1af57050 00000000`00000000 00000000`00000000
#1af57060 00000000`00000000 00000000`00000000
#1af57070 00000000`00000000 00000000`00000000
kd> !dq 167f1000 + 2*8
#167f1010 58000000`0caf1867 14000000`1df1c867
#167f1020 28500000`1e1b8867 00000000`00000000
#167f1030 00000000`00000000 00000000`00000000
#167f1040 00000000`00000000 00000000`00000000
#167f1050 00000000`00000000 00000000`00000000
#167f1060 00000000`00000000 00000000`00000000
#167f1070 50700000`1ddc9867 42700000`1e10c867
#167f1080 47600000`1cd80867 54700000`1e5ff867
kd> !dq 0caf1000 + 1*8
# caf1008 2d500000`1e7dc867 2d600000`1e6dd867
# caf1018 2d800000`1e8df867 2d900000`1e860867
# caf1028 2da00000`1e7e1867 2dc00000`1e7e3867
# caf1038 50800000`1e7e4867 2de00000`1e765867
# caf1048 2df00000`1e866867 2e000000`1e7e7867
# caf1058 2e200000`1e7e9867 2e300000`1e76a867
# caf1068 68e00000`1e7eb867 5dd00000`1e66d867
# caf1078 69100000`1e5ee867 2e800000`1e5ef867
kd> !db 1e7dc020
#1e7dc020  64 89 10 68 30 10 40 00-c3 e9 d2 ff ff ff eb f8  d..h0.@.........
#1e7dc030  5d c3 8b c0 83 2d 00 70-40 00 01 c3 c3 8d 40 00  ]....-.p@.....@.
#1e7dc040  c3 8d 40 00 55 8b ec 33-c0 55 68 69 10 40 00 64  ..@.U..3.Uhi.@.d
#1e7dc050  ff 30 64 89 20 ff 05 04-70 40 00 33 c0 5a 59 59  .0d. ...p@.3.ZYY
#1e7dc060  64 89 10 68 70 10 40 00-c3 e9 92 ff ff ff eb f8  d..hp.@.........
#1e7dc070  5d c3 8b c0 83 2d 04 70-40 00 01 c3 85 d2 74 1f  ]....-.p@.....t.
#1e7dc080  57 51 56 89 c7 31 c9 31-c0 f7 d1 f2 ae 4f 57 89  WQV..1.1.....OW.
#1e7dc090  d7 f2 ae 89 f9 29 d1 89-d6 5f f3 a4 5e 59 5f c3  .....)..._..^Y_.

kd> db 401020
`00401020  64 89 10 68 30 10 40 00-c3 e9 d2 ff ff ff eb f8  d..h0.@.........
`00401030  5d c3 8b c0 83 2d 00 70-40 00 01 c3 c3 8d 40 00  ]....-.p@.....@.
`00401040  c3 8d 40 00 55 8b ec 33-c0 55 68 69 10 40 00 64  ..@.U..3.Uhi.@.d
`00401050  ff 30 64 89 20 ff 05 04-70 40 00 33 c0 5a 59 59  .0d. ...p@.3.ZYY
`00401060  64 89 10 68 70 10 40 00-c3 e9 92 ff ff ff eb f8  d..hp.@.........
`00401070  5d c3 8b c0 83 2d 04 70-40 00 01 c3 85 d2 74 1f  ]....-.p@.....t.
`00401080  57 51 56 89 c7 31 c9 31-c0 f7 d1 f2 ae 4f 57 89  WQV..1.1.....OW.
`00401090  d7 f2 ae 89 f9 29 d1 89-d6 5f f3 a4 5e 59 5f c3  .....)..._..^Y_.
```

